<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathChallenge - Juego de Matemáticas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            color: #333;
        }
        
        .container {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
            padding: 20px;
            margin-top: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        h1 {
            color: #4a6fa5;
            margin: 0;
        }
        
        .player-info {
            display: flex;
            align-items: center;
            margin-top: 10px;
            background-color: #e0e8f5;
            padding: 8px 15px;
            border-radius: 20px;
        }
        
        .player-avatar {
            width: 30px;
            height: 30px;
            background-color: #4a6fa5;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .player-name {
            font-weight: bold;
            color: #4a6fa5;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background-color: #4a6fa5;
            color: white;
            border-radius: 5px;
        }
        
        .problem-container {
            font-size: 32px;
            text-align: center;
            margin: 30px 0;
            font-weight: bold;
            min-height: 50px;
        }
        
        .options-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 8px;
            margin-top: 20px;
        }
        
        .option-button {
            padding: 12px 5px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            background-color: #e0e8f5;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .option-button:hover {
            background-color: #d0dcf0;
            transform: scale(1.05);
        }
        
        .option-button:active {
            transform: scale(0.98);
        }
        
        .option-button.selected {
            background-color: #4a6fa5;
            color: white;
        }
        
        .option-button.correct {
            background-color: #4caf50;
            color: white;
        }
        
        .option-button.incorrect {
            background-color: #f44336;
            color: white;
        }
        
        .timer-bar {
            height: 10px;
            background-color: #e74c3c;
            width: 100%;
            border-radius: 5px;
            margin-top: 20px;
            transition: width 0.1s linear;
        }
        
        .controls {
            display: flex;
            margin-top: 20px;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .button {
            padding: 10px 20px;
            background-color: #4a6fa5;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.2s;
        }
        
        .button:hover {
            background-color: #3a5a8a;
        }
        
        .results {
            margin-top: 20px;
            text-align: center;
            display: none;
        }
        
        .results h2 {
            color: #4a6fa5;
        }
        
        .stat {
            font-size: 18px;
            margin: 5px 0;
        }
        
        .ranking {
            margin-top: 20px;
            width: 90%;
            max-width: 600px;
            margin-bottom: 30px;
        }
        
        .ranking h2 {
            color: #4a6fa5;
            text-align: center;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #4a6fa5;
            color: white;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .highlight {
            background-color: #ffe6a8 !important;
        }
        
        .player-form {
            margin-bottom: 20px;
            text-align: center;
        }
        
        .player-input {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
            width: 200px;
            margin-right: 10px;
        }
        
        .error-message {
            color: #f44336;
            font-size: 14px;
            margin-top: 8px;
            text-align: center;
            display: none;
        }
        
        .game-modes {
            text-align: center;
            margin-bottom: 20px;
        }
        
        .mode-selector {
            display: flex;
            margin-bottom: 20px;
            justify-content: center;
            gap: 10px;
        }
        
        .mode-button {
            padding: 8px 16px;
            background-color: #e0e8f5;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .mode-button.selected {
            background-color: #4a6fa5;
            color: white;
        }
        
        .footer {
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: center;
            color: #666;
            font-size: 14px;
            width: 90%;
            max-width: 600px;
        }
        
        @media (max-width: 480px) {
            .options-grid {
                grid-template-columns: repeat(4, 1fr);
                grid-template-rows: repeat(4, 1fr);
                gap: 5px;
            }
            
            .option-button {
                padding: 10px 5px;
                font-size: 16px;
            }
            
            .problem-container {
                font-size: 28px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>MathChallenge</h1>
            <div class="player-info" id="player-display" style="display: none;">
                <div class="player-avatar" id="player-avatar"></div>
                <div class="player-name" id="player-name-display"></div>
            </div>
        </header>
        
        <div id="player-form" class="player-form">
            <input type="text" id="player-name-input" class="player-input" placeholder="Tu nombre de jugador">
            <button class="button" id="save-name-button">Guardar</button>
            <div id="error-message" class="error-message">Por favor ingresa un nombre válido</div>
        </div>
        
        <div id="game-modes" class="game-modes" style="display: none;">
            <h3>Elige el modo de juego:</h3>
            <div class="mode-selector">
                <button id="mode-free" class="mode-button selected">Modo Libre</button>
                <button id="mode-challenge" class="mode-button">Modo Desafío</button>
            </div>
        </div>
        
        <div class="status-bar">
            <div id="score">Puntos: 0</div>
            <div id="timer">30 s</div>
        </div>
        
        <div id="question-container">
            <div class="problem-container" id="problem"></div>
            <div class="options-grid" id="options">
                <!-- Opciones generadas dinámicamente -->
            </div>
        </div>
        
        <div class="timer-bar" id="timer-bar"></div>
        
        <div class="controls">
            <button class="button" id="start-button" style="display: none;">¡Comenzar Juego!</button>
        </div>
        
        <div class="results" id="results">
            <h2>¡Fin del Juego!</h2>
            <div class="stat">Puntuación Final: <span id="final-score">0</span></div>
            <div class="stat">Preguntas Correctas: <span id="correct-count">0</span></div>
            <div class="stat">Tiempo Promedio: <span id="avg-time">0</span> segundos</div>
            <button class="button" id="restart-button" style="margin-top: 15px;">Jugar de Nuevo</button>
        </div>
    </div>
    
    <div class="ranking">
        <h2>Tabla de Clasificación</h2>
        <table id="leaderboard">
            <tr>
                <th>Posición</th>
                <th>Jugador</th>
                <th>Puntuación</th>
                <th>Tiempo</th>
            </tr>
            <!-- Las filas se generan dinámicamente -->
        </table>
    </div>
    
    <div class="footer">
        <p>¿Te gustó el juego? ¡Compártelo con tus amigos!</p>
        <p>© 2025 MathChallenge - Todos los derechos reservados</p>
    </div>

    <script>
        // Variables globales
        let currentProblem = {};
        let score = 0;
        let timer = 30;
        let timerInterval;
        let gameActive = false;
        let problems = [];
        let correctAnswers = 0;
        let totalTime = 0;
        let questionStartTime = 0;
        let playerName = "";
        let gameMode = "free"; // "free" o "challenge"
        
        // Referencias DOM - Una vez que el DOM está cargado
        document.addEventListener('DOMContentLoaded', function() {
            // Obtener referencias a elementos del DOM
            const problemEl = document.getElementById('problem');
            const optionsEl = document.getElementById('options');
            const scoreEl = document.getElementById('score');
            const timerEl = document.getElementById('timer');
            const timerBarEl = document.getElementById('timer-bar');
            const startButton = document.getElementById('start-button');
            const resultsEl = document.getElementById('results');
            const finalScoreEl = document.getElementById('final-score');
            const correctCountEl = document.getElementById('correct-count');
            const avgTimeEl = document.getElementById('avg-time');
            const restartButton = document.getElementById('restart-button');
            const playerFormEl = document.getElementById('player-form');
            const playerNameInput = document.getElementById('player-name-input');
            const saveNameButton = document.getElementById('save-name-button');
            const playerDisplayEl = document.getElementById('player-display');
            const playerNameDisplayEl = document.getElementById('player-name-display');
            const playerAvatarEl = document.getElementById('player-avatar');
            const errorMessageEl = document.getElementById('error-message');
            const gameModesEl = document.getElementById('game-modes');
            const modeButtonFree = document.getElementById('mode-free');
            const modeButtonChallenge = document.getElementById('mode-challenge');
            
            // Event listeners básicos
            saveNameButton.addEventListener('click', function() {
                const name = playerNameInput.value.trim();
                
                if (!name) {
                    errorMessageEl.style.display = 'block';
                    return;
                }
                
                errorMessageEl.style.display = 'none';
                playerName = name;
                
                try {
                    localStorage.setItem('mathGamePlayerName', name);
                } catch (error) {
                    console.error("Error al guardar en localStorage:", error);
                }
                
                playerFormEl.style.display = 'none';
                playerDisplayEl.style.display = 'flex';
                playerNameDisplayEl.textContent = playerName;
                
                const initial = playerName.charAt(0).toUpperCase();
                playerAvatarEl.textContent = initial || '👤';
                
                startButton.style.display = 'block';
                gameModesEl.style.display = 'block';
            });
            
            // Evento de tecla Enter en input del nombre
            playerNameInput.addEventListener('keypress', function(event) {
                if (event.key === 'Enter') {
                    saveNameButton.click();
                }
            });
            
            startButton.addEventListener('click', function() {
                // Verificar que haya un nombre de jugador
                if (!playerName) {
                    errorMessageEl.textContent = 'Por favor, ingresa tu nombre antes de comenzar';
                    errorMessageEl.style.display = 'block';
                    return;
                }
                
                // Resetear variables
                score = 0;
                timer = 30;
                problems = [];
                correctAnswers = 0;
                totalTime = 0;
                gameActive = true;
                
                // Actualizar UI
                scoreEl.textContent = `Puntos: ${score}`;
                timerEl.textContent = `${timer} s`;
                timerBarEl.style.width = '100%';
                resultsEl.style.display = 'none';
                startButton.style.display = 'none';
                gameModesEl.style.display = 'none';
                
                // Generar primer problema
                generateProblem();
                
                // Iniciar temporizador
                timerInterval = setInterval(updateTimer, 1000);
            });
            
            restartButton.addEventListener('click', function() {
                startButton.click();
            });
            
            // Event listeners para modos de juego
            modeButtonFree.addEventListener('click', function() {
                setGameMode('free');
            });
            
            modeButtonChallenge.addEventListener('click', function() {
                setGameMode('challenge');
            });
            
            // Comprobar si ya hay un nombre guardado
            checkSavedName();
            
            // Cargar puntuaciones guardadas
            loadScores();
            
            // Configuración de dificultad
            const DIFFICULTY = {
                EASY: { min: 1, max: 10, operations: ['+', '-'] },
                MEDIUM: { min: 5, max: 20, operations: ['+', '-', '*'] },
                HARD: { min: 10, max: 50, operations: ['+', '-', '*', '/'] }
            };
            
            // Cambiar modo de juego
            function setGameMode(mode) {
                gameMode = mode;
                if (mode === 'free') {
                    modeButtonFree.classList.add('selected');
                    modeButtonChallenge.classList.remove('selected');
                } else {
                    modeButtonFree.classList.remove('selected');
                    modeButtonChallenge.classList.add('selected');
                }
            }
            
            // Comprobar si hay un nombre guardado
            function checkSavedName() {
                try {
                    const savedName = localStorage.getItem('mathGamePlayerName');
                    if (savedName && savedName.trim() !== '') {
                        playerName = savedName;
                        playerNameInput.value = savedName;
                        
                        playerFormEl.style.display = 'none';
                        playerDisplayEl.style.display = 'flex';
                        playerNameDisplayEl.textContent = playerName;
                        
                        const initial = playerName.charAt(0).toUpperCase();
                        playerAvatarEl.textContent = initial || '👤';
                        
                        startButton.style.display = 'block';
                        gameModesEl.style.display = 'block';
                    }
                } catch (error) {
                    console.error("Error al acceder al localStorage:", error);
                }
            }
            
            // Actualizar temporizador
            function updateTimer() {
                timer--;
                
                // Actualizar UI
                timerEl.textContent = `${timer} s`;
                timerBarEl.style.width = `${(timer / 30) * 100}%`;
                
                // Comprobar fin del tiempo
                if (timer <= 0) {
                    endGame();
                }
            }
            
            // Generar problema matemático
            function generateProblem() {
                // Seleccionar dificultad basada en la puntuación
                let difficulty;
                if (score < 50) {
                    difficulty = DIFFICULTY.EASY;
                } else if (score < 100) {
                    difficulty = DIFFICULTY.MEDIUM;
                } else {
                    difficulty = DIFFICULTY.HARD;
                }
                
                // Generar operación
                const num1 = randomInt(difficulty.min, difficulty.max);
                const num2 = randomInt(difficulty.min, difficulty.max);
                const operation = difficulty.operations[randomInt(0, difficulty.operations.length - 1)];
                
                // Cálculo del resultado correcto
                let correctResult;
                let problemText;
                
                switch (operation) {
                    case '+':
                        correctResult = num1 + num2;
                        problemText = `${num1} + ${num2}`;
                        break;
                    case '-':
                        // Asegurar que el resultado no sea negativo
                        if (num1 < num2) {
                            correctResult = num2 - num1;
                            problemText = `${num2} - ${num1}`;
                        } else {
                            correctResult = num1 - num2;
                            problemText = `${num1} - ${num2}`;
                        }
                        break;
                    case '*':
                        correctResult = num1 * num2;
                        problemText = `${num1} × ${num2}`;
                        break;
                    case '/':
                        // Asegurar división exacta
                        correctResult = num1;
                        problemText = `${num1 * num2} ÷ ${num2}`;
                        break;
                }
                
                // Generar opciones para la cuadrícula (una correcta y el resto incorrectas)
                const gridSize = 16; // 4x4 grid
                const options = [correctResult];
                
                // Rango para números de distracción
                const minOption = Math.max(1, correctResult - 20);
                const maxOption = correctResult + 20;
                
                // Contador para evitar bucles infinitos
                let attempts = 0;
                
                while (options.length < gridSize && attempts < 100) {
                    attempts++;
                    
                    // Generar opción incorrecta
                    let incorrectOption;
                    
                    // 50% cerca del resultado, 50% más aleatorio
                    if (Math.random() > 0.5) {
                        // Opción cercana
                        const offset = randomInt(1, 5);
                        incorrectOption = correctResult + (Math.random() > 0.5 ? offset : -offset);
                    } else {
                        // Opción más aleatoria dentro del rango
                        incorrectOption = randomInt(minOption, maxOption);
                    }
                    
                    // Añadir si no está ya en las opciones
                    if (!options.includes(incorrectOption) && incorrectOption >= 0) {
                        options.push(incorrectOption);
                    }
                }
                
                // Si no conseguimos llenar la cuadrícula, completar con números aleatorios
                while (options.length < gridSize) {
                    const randomNum = randomInt(1, 100);
                    if (!options.includes(randomNum)) {
                        options.push(randomNum);
                    }
                }
                
                // Mezclar opciones
                shuffleArray(options);
                
                // Guardar problema actual
                currentProblem = {
                    text: problemText,
                    options: options,
                    correctAnswer: correctResult
                };
                
                // Mostrar problema
                displayProblem();
                
                // Guardar tiempo de inicio
                questionStartTime = Date.now();
            }
            
            // Mostrar problema en la UI
            function displayProblem() {
                problemEl.textContent = currentProblem.text;
                optionsEl.innerHTML = '';
                
                currentProblem.options.forEach(option => {
                    const button = document.createElement('button');
                    button.className = 'option-button';
                    button.textContent = option;
                    button.addEventListener('click', function() {
                        checkAnswer(option);
                    });
                    optionsEl.appendChild(button);
                });
            }
            
            // Comprobar respuesta
            function checkAnswer(selectedAnswer) {
                if (!gameActive) return;
                
                // Calcular tiempo para responder
                const answerTime = (Date.now() - questionStartTime) / 1000;
                totalTime += answerTime;
                
                // Obtener todos los botones
                const buttons = document.querySelectorAll('.option-button');
                
                // Deshabilitar todos los botones
                buttons.forEach(button => {
                    button.disabled = true;
                    
                    // Marcar botón correcto e incorrecto
                    if (parseInt(button.textContent) === currentProblem.correctAnswer) {
                        button.classList.add('correct');
                    } else if (parseInt(button.textContent) === selectedAnswer && selectedAnswer !== currentProblem.correctAnswer) {
                        button.classList.add('incorrect');
                    }
                });
                
                // Comprobar si la respuesta es correcta
                if (selectedAnswer === currentProblem.correctAnswer) {
                    // Calcular puntos basados en tiempo de respuesta
                    const pointsEarned = Math.max(5, Math.floor(30 - answerTime) * 2);
                    score += pointsEarned;
                    scoreEl.textContent = `Puntos: ${score}`;
                    correctAnswers++;
                }
                
                // Guardar problema para historial
                problems.push({
                    problem: currentProblem.text,
                    correct: selectedAnswer === currentProblem.correctAnswer,
                    time: answerTime
                });
                
                // Esperar antes de mostrar siguiente problema
                setTimeout(() => {
                    if (gameActive) {
                        generateProblem();
                    }
                }, 1000);
            }
            
            // Finalizar juego
            function endGame() {
                gameActive = false;
                clearInterval(timerInterval);
                
                // Mostrar resultados
                finalScoreEl.textContent = score;
                correctCountEl.textContent = correctAnswers;
                avgTimeEl.textContent = problems.length > 0 ? (totalTime / problems.length).toFixed(1) : '0';
                
                resultsEl.style.display = 'block';
                startButton.style.display = 'block';
                gameModesEl.style.display = 'block';
                
                // Guardar puntuación localmente
                saveScore(score, totalTime / problems.length);
            }
            
            // Guardar puntuación (simulado)
            function saveScore(score, avgTime) {
                try {
                    // Obtener puntuaciones anteriores del almacenamiento local
                    let scores = [];
                    const savedScores = localStorage.getItem('mathGameScores');
                    
                    if (savedScores) {
                        try {
                            scores = JSON.parse(savedScores);
                            // Comprobar que sea un array
                            if (!Array.isArray(scores)) {
                                scores = [];
                            }
                        } catch (e) {
                            console.error("Error parsing scores:", e);
                            scores = [];
                        }
                    }
                    
                    // Añadir nueva puntuación
                    scores.push({
                        name: playerName,
                        score: score,
                        time: avgTime,
                        date: new Date().toISOString()
                    });
                    
                    // Ordenar por puntuación (descendente) y luego por tiempo (ascendente)
                    scores.sort((a, b) => {
                        if (a.score !== b.score) {
                            return b.score - a.score;
                        }
                        return a.time - b.time;
                    });
                    
                    // Limitar a 10 mejores puntuaciones
                    scores = scores.slice(0, 10);
                    
                    // Guardar en almacenamiento local
                    localStorage.setItem('mathGameScores', JSON.stringify(scores));
                    
                    // Actualizar tabla de clasificación
                    updateLeaderboard(scores);
                } catch (error) {
                    console.error("Error al guardar puntuación:", error);
                    // Si hay error de localStorage, actualizar tabla de todas formas con puntuación actual
                    updateLeaderboardWithCurrentScore(score, avgTime);
                }
            }
            
            // Actualizar tabla solo con puntuación actual (fallback)
            function updateLeaderboardWithCurrentScore(score, avgTime) {
                const leaderboard = document.getElementById('leaderboard');
                
                // Mantener solo la fila de cabecera
                while (leaderboard.rows.length > 1) {
                    leaderboard.deleteRow(1);
                }
                
                // Añadir puntuación actual
                const row = leaderboard.insertRow();
                row.classList.add('highlight');
                
                // Añadir celdas
                const posCell = row.insertCell(0);
                const nameCell = row.insertCell(1);
                const scoreCell = row.insertCell(2);
                const timeCell = row.insertCell(3);
                
                posCell.textContent = 1;
                nameCell.textContent = playerName;
                scoreCell.textContent = score;
                timeCell.textContent = `${avgTime.toFixed(1)}s`;
            }
            
            // Actualizar tabla de clasificación
            function updateLeaderboard(scores) {
                const leaderboard = document.getElementById('leaderboard');
                
                // Mantener solo la fila de cabecera
                while (leaderboard.rows.length > 1) {
                    leaderboard.deleteRow(1);
                }
                
                // Si no hay puntuaciones, salir
                if (!scores || scores.length === 0) return;
                
                // Añadir puntuaciones
                scores.forEach((scoreItem, index) => {
                    const row = leaderboard.insertRow();
                    
                    // Destacar jugador actual
                    const isCurrent = scoreItem.name === playerName && 
                                     scoreItem.date && 
                                     new Date(scoreItem.date).getTime() > Date.now() - 60000; // Si se agregó en el último minuto
                    if (isCurrent) {
                        row.classList.add('highlight');
                    }
                    
                    // Añadir celdas
                    const posCell = row.insertCell(0);
                    const nameCell = row.insertCell(1);
                    const scoreCell = row.insertCell(2);
                    const timeCell = row.insertCell(3);
                    
                    posCell.textContent = index + 1;
                    nameCell.textContent = scoreItem.name || 'Anónimo';
                    scoreCell.textContent = scoreItem.score || 0;
                    timeCell.textContent = scoreItem.time ? `${scoreItem.time.toFixed(1)}s` : '0s';
                });
            }
            
            // Cargar puntuaciones guardadas al inicio
            function loadScores() {
                try {
                    const savedScores = localStorage.getItem('mathGameScores');
                    if (savedScores) {
                        const scores = JSON.parse(savedScores);
                        if (Array.isArray(scores) && scores.length > 0) {
                            updateLeaderboard(scores);
                        }
                    }
                } catch (error) {
                    console.error("Error al cargar puntuaciones:", error);
                }
            }
        });

        // Utilidades (fuera del DOMContentLoaded)
        function randomInt(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
